<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Training Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html,body{height:100%;}</style>
</head>
<body class="bg-slate-100">
  <div id="app" class="min-h-screen grid grid-cols-12 gap-4 p-4">
    <aside class="col-span-3 bg-white rounded-xl border p-3 flex flex-col">
      <div class="flex items-center gap-2 mb-2">
        <h1 class="font-semibold">Trainees</h1>
        <button id="refresh" class="ml-auto text-xs px-2 py-1 rounded bg-indigo-600 text-white">Refresh</button>
      </div>
      <input id="search" class="border rounded px-2 py-1 text-sm mb-2" placeholder="Search name or email"/>
      <div id="list" class="flex-1 overflow-auto space-y-1 text-sm"></div>
    </aside>

    <main class="col-span-9 bg-white rounded-xl border p-4">
      <div id="detailEmpty" class="text-slate-500">Select a trainee to view their latest report.</div>
      <div id="detail" class="hidden"></div>
    </main>
  </div>

  <script>
    const listEl   = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const refreshEl= document.getElementById('refresh');
    const detailEl = document.getElementById('detail');
    const emptyEl  = document.getElementById('detailEmpty');

    async function fetchList(q=''){
      const r = await fetch('/api/report-list'+(q?`?search=${encodeURIComponent(q)}`:''));
      const data = await r.json();
      return data.items || [];
    }
    async function fetchReportByNameKey(nameKey){
      const r = await fetch('/api/report-get?nameKey='+encodeURIComponent(nameKey));
      if(!r.ok) return null;
      return await r.json();
    }

    function fmtPct(x){ return (x==null||isNaN(x))?'—':`${Math.round(x)}%`; }
    function fmtTime(ts){ try { return new Date(Number(ts)).toLocaleString(); } catch { return '—'; } }

    function renderList(items){
      listEl.innerHTML = '';
      if (!items.length){
        listEl.innerHTML = '<div class="text-slate-500 text-sm p-2">No trainees found.</div>';
        return;
      }
      for (const it of items){
        const row = document.createElement('button');
        row.className = 'w-full text-left px-2 py-2 rounded hover:bg-slate-100 border';
        row.innerHTML = `
          <div class="font-medium">${it.name}</div>
          <div class="text-xs text-slate-500">${it.email||''}</div>
          <div class="text-xs mt-1">Last: <span class="font-semibold">${fmtPct(it.lastPct)}</span> • ${fmtTime(it.updatedAt)}</div>
        `;
        row.onclick = async ()=>{
          const run = await fetchReportByNameKey(it.nameKey);
          if (!run) { detailEl.classList.add('hidden'); emptyEl.classList.remove('hidden'); return; }
          renderDetail(run);
        };
        listEl.appendChild(row);
      }
    }

    function renderDetail(run){
      emptyEl.classList.add('hidden');
      detailEl.classList.remove('hidden');

      const ov = run.overall || {};
      const scores = run.scoresByChannel || {};
      const chKeys = Object.keys(scores);

      let html = `
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-xl font-semibold">${run.name}</div>
            <div class="text-sm text-slate-500">${run.email||''}</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-500">Completed</div>
            <div class="font-semibold">${fmtTime(run.endedAt || run.createdAt)}</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-4">
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="text-xs text-slate-500">Overall</div>
            <div class="text-2xl font-semibold">${ov.correct||0}/${ov.total||0} (${fmtPct(ov.pct)})</div>
          </div>
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="text-xs text-slate-500">Channels Completed</div>
            <div class="text-2xl font-semibold">${chKeys.filter(k=>scores[k]).length}</div>
          </div>
          <div class="border rounded-xl p-3 bg-slate-50">
            <div class="text-xs text-slate-500">Run ID</div>
            <div class="text-sm font-mono">${run.runId}</div>
          </div>
        </div>
      `;

      // Per-channel summary
      html += `<div class="mb-3 font-semibold">Per-channel</div>`;
      html += `<div class="grid md:grid-cols-2 gap-3 mb-4">`;
      for (const [id, s] of Object.entries(scores)){
        if (!s) continue;
        html += `
          <div class="border rounded-xl p-3">
            <div class="text-sm font-medium">${id}</div>
            <div class="text-xs text-slate-500">${s.total}/${(s.results||[]).length} (${s.pct}%)</div>
          </div>
        `;
      }
      html += `</div>`;

      // Full Q/A (if provided)
      if (run.qaByChannel) {
        html += `<div class="mb-3 font-semibold">Answers</div>`;
        for (const [id, arr] of Object.entries(run.qaByChannel)) {
          if (!arr || !arr.length) continue;
          html += `<div class="mb-2 text-sm font-semibold">${id}</div>`;
          html += `<div class="space-y-2 mb-4">`;
          for (const row of arr) {
            html += `
              <div class="border rounded-lg p-3 bg-slate-50">
                <div class="text-[12px] text-slate-500 mb-1">${row.q}</div>
                <div class="text-sm"><span class="px-2 py-0.5 rounded ${row.passed?'bg-emerald-100 text-emerald-700':'bg-rose-100 text-rose-700'}">${row.passed?'Correct':'Needs Work'}</span></div>
                <div class="mt-2 text-sm">
                  <div class="text-slate-500 mb-1">Answer</div>
                  <div class="bg-white border rounded p-2">${row.a || ''}</div>
                </div>
                ${row.missing?.length ? `<div class="mt-2 text-xs">Missing: ${row.missing.join(', ')}</div>` : ''}
                ${row.matched?.length ? `<div class="mt-1 text-xs">Matched: ${row.matched.join(', ')}</div>` : ''}
                ${row.why ? `<div class="mt-1 text-xs italic text-slate-700">Why: ${row.why}</div>` : ''}
              </div>
            `;
          }
          html += `</div>`;
        }
      }

      detailEl.innerHTML = html;
    }

    async function refresh(){ renderList(await fetchList(searchEl.value)); }

    refreshEl.onclick = refresh;
    searchEl.oninput = ()=>{ refresh(); };
    refresh();
  </script>
</body>
</html>
