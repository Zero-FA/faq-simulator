<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apex Trader Funding</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    html, body { height: 100%; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .bubble { border-radius: 1rem; padding: .75rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,.05); border: 1px solid rgba(0,0,0,.08); }
    .ch-item { cursor: pointer; border-radius: .5rem; padding:.5rem .75rem; display:flex; gap:.5rem; align-items:center;}
    .ch-item.active { background: rgb(30 41 59 / .55); }
    .dot { width:.5rem; height:.5rem; border-radius:9999px; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="min-h-screen"></div>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const USE_MOCK = false;
    const COACH_URL = '/api/coach';
    const GRADE_URL = '/api/grader';
    const CHECK_ACCESS_URL = '/api/check-access';

    const CHANNELS = [
      { id: 'platform-setup',       name: '#platform-setup',       file: '/faqs/platform-setup.md',      dot:'bg-indigo-400' },
      { id: 'evaluation-content',   name: '#evaluation-content',   file: '/faqs/evaluation-content.md',  dot:'bg-emerald-400' },
      { id: 'performance-account',  name: '#performance-account',  file: '/faqs/performance-account.md', dot:'bg-pink-400' },
      { id: 'billing',              name: '#billing',              file: '/faqs/billing.md',             dot:'bg-amber-400' },
      { id: 'affiliate-program',    name: '#affiliate-program',    file: '/faqs/affiliate-program.md',   dot:'bg-cyan-400' },
      { id: 'tech-support',         name: '#tech-support',         file: '/faqs/tech-support.md',        dot:'bg-violet-400' },
    ];

    const QUESTIONS_PER_RUN = 5;
    const RUN_SECONDS = 10 * 60; // 10:00

    async function fetchFAQMd(channelId){
      const ch = CHANNELS.find(c=>c.id===channelId);
      if(!ch) throw new Error('Unknown channel');
      const r = await fetch(ch.file, { cache:'no-store' });
      if(!r.ok) throw new Error(`Failed to load ${ch.file}: ${r.status}`);
      return await r.text();
    }

    function Avatar({variant="bot"}) {
      const color = variant==="bot" ? "bg-indigo-500" : "bg-emerald-500";
      return <div className={`w-9 h-9 ${color} text-white rounded-full grid place-items-center font-semibold`}>{variant==="bot"?"C":"T"}</div>;
    }

    function Row({from="bot", text, time}) {
      const isBot = from==="bot";
      return (
        <div className={`flex items-end gap-3 ${isBot?"":"justify-end"}`}>
          {isBot && <Avatar variant="bot" />}
          <div className="flex flex-col gap-1 max-w-[70ch]">
            <div className="text-[10px] text-slate-500">{isBot?"Coach":"Trainee"} • {time}</div>
            <div className={`bubble ${isBot ? "bg-white" : "bg-emerald-50 border-emerald-200"}`}>{text}</div>
          </div>
          {!isBot && <Avatar variant="user" />}
        </div>
      );
    }

    function App() {
      const [channelId, setChannelId] = useState(CHANNELS[0].id);
      const [faqMd, setFaqMd] = useState('');
      const [messages, setMessages] = useState([]);
      const [history, setHistory] = useState([]);
      const [draft, setDraft] = useState('');
      const [started, setStarted] = useState(false);
      const [finished, setFinished] = useState(false);
      const [qCount, setQCount] = useState(0);
      const [grading, setGrading] = useState(null);
      const [typing, setTyping] = useState(false);
      const [secondsLeft, setSecondsLeft] = useState(RUN_SECONDS);

      const [unlockedIdx, setUnlockedIdx] = useState(0);
      const [completedIds, setCompletedIds] = useState(new Set());
      const [notice, setNotice] = useState('');

      const scrollRef = useRef(null);
      const timerRef = useRef(null);
      const now = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      useEffect(()=>{
        (async ()=>{
          try {
            const md = await fetchFAQMd(channelId);
            setFaqMd(md);
            setStarted(false);
            setFinished(false);
            setQCount(0);
            setSecondsLeft(RUN_SECONDS);
            setHistory([]);
            setGrading(null);
            setDraft('');
            setMessages([]);
          } catch(e){
            console.error(e);
          }
        })();
      }, [channelId]);

      useEffect(()=>{ scrollRef.current?.scrollTo({ top: 999999, behavior: 'smooth' }); }, [messages, typing]);

      function toast(msg){
        setNotice(msg);
        setTimeout(()=>setNotice(''), 1800);
      }

      function startTimer(){
        timerRef.current = setInterval(()=>{
          setSecondsLeft(prev=>{
            if(prev<=1){
              clearInterval(timerRef.current);
              endRun();
              return 0;
            }
            return prev-1;
          })
        },1000);
      }

      async function startRun(){
        setStarted(true); setFinished(false); setQCount(0); setGrading(null); setMessages([]); setHistory([]);
        startTimer();
        setMessages([{from:'bot', text:"I’ll ask you 5 quick questions. Answer using the FAQs. Ready?", time: now()}]);
        await askNext();
      }

      async function askNext(){
        if (qCount >= QUESTIONS_PER_RUN) { endRun(); return; }
        setTyping(true);
        try{
          const reply = USE_MOCK 
            ? { content: "Sample question?" }
            : await (await fetch(COACH_URL, {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ channel: channelId, history, faqMd })
              })).json();
          const text = reply?.content?.trim() || "Ask: (No coach output)";
          setMessages(m=>[...m, {from:'bot', text, time: now()}]);
          setHistory(h=>[...h, {role:'assistant', content:text}]);
        } catch (e) {
          setMessages(m=>[...m, {from:'bot', text:`Coach error: ${e.message}`, time: now()}]);
        } finally {
          setTyping(false);
        }
      }

      function endRun(passedResults){
        if (finished) return;
        if (timerRef.current) clearInterval(timerRef.current);
        setFinished(true);

        const results = passedResults ?? (grading?.results || []);
        const total = results.filter(r=>r.passed).length;
        const pct = Math.round(((total||0)/QUESTIONS_PER_RUN)*100);

        setMessages(m=>[...m, {from:'bot', text:`Test complete. You scored ${total||0}/${QUESTIONS_PER_RUN} (${pct}%).`, time: now()}]);

        if (results.length >= QUESTIONS_PER_RUN) {
          setCompletedIds(prev => new Set(prev).add(channelId));
          const currentIdx = CHANNELS.findIndex(c => c.id === channelId);
          setUnlockedIdx(prev => Math.max(prev, Math.min(currentIdx + 1, CHANNELS.length - 1)));
        }
      }

      async function submit(){
        if (!draft.trim() || !started || finished) return;
        const userText = draft.trim();
        setDraft('');
        setMessages(m=>[...m, {from:'user', text:userText, time: now()}]);
        setHistory(h=>[...h, {role:'user', content:userText}]);

        const lastQuestion = [...messages].reverse().find(m=>m.from==='bot')?.text || 'Coach question';
        try {
          const result = await (await fetch(GRADE_URL, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ channel: channelId, question:lastQuestion, answer:userText, faqMd })
          })).json();

          const nextCount = qCount + 1;
          setQCount(nextCount);
          setGrading(g=>{
            const prev = g?.results || [];
            const cur = { qText:lastQuestion, ans:userText, ...result };
            const nextResults = [...prev, cur];
            if (nextCount >= QUESTIONS_PER_RUN) {
              endRun(nextResults);
            } else {
              askNext();
            }
            return { results: nextResults };
          });
        } catch (e) {
          const nextCount = qCount + 1;
          setQCount(nextCount);
        }
      }

      function trySwitchChannel(targetId, targetIdx){
        if (started && !finished) {
          toast("Finish this run before switching channels.");
          return;
        }
        if (targetIdx > unlockedIdx) {
          toast("Locked. Complete the previous channel first.");
          return;
        }
        setChannelId(targetId);
      }

      return (
        <div className="grid grid-cols-12 min-h-screen">
          {/* Sidebar */}
          <aside className="col-span-2 hidden md:flex flex-col bg-slate-900 text-slate-200 p-3 gap-3">
            <div className="text-xs uppercase tracking-widest text-slate-400">Channels</div>
            <div className="space-y-1">
              {CHANNELS.map((ch, idx)=>{
                const isActive = channelId===ch.id;
                const locked = idx > unlockedIdx;
                return (
                  <div key={ch.id}
                       className={`ch-item ${isActive?'active hover:bg-slate-800':'hover:bg-slate-800/60'} ${locked?'opacity-40 cursor-not-allowed':''}`}
                       onClick={()=>trySwitchChannel(ch.id, idx)}>
                    <span className={`dot ${ch.dot}`}></span>
                    <span className="truncate">{ch.name}</span>
                    {completedIds.has(ch.id) && <span className="ml-auto text-[10px] px-1 py-0.5 rounded bg-emerald-600/20 text-emerald-300">done</span>}
                    {locked && !completedIds.has(ch.id) && <span className="ml-auto text-[10px] px-1 py-0.5 rounded bg-slate-700 text-slate-300">locked</span>}
                  </div>
                );
              })}
            </div>
            <div className="mt-2 h-5 text-xs text-amber-300">{notice}</div>
          </aside>

          {/* Main */}
          <main className="col-span-12 md:col-span-10 p-4 md:p-6 grid gap-3 content-start">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2 text-slate-700">
                <h1 className="text-xl font-semibold">Apex Trader Funding</h1>
                <span className="text-xs bg-slate-200 text-slate-700 px-2 py-0.5 rounded">{CHANNELS.find(c=>c.id===channelId)?.name}</span>
              </div>
              <div className="flex items-center gap-3">
                <div className={`text-sm font-semibold text-slate-700 ${started&&!finished?'':'hidden'}`}>{`${String(Math.floor(secondsLeft/60)).padStart(2,'0')}:${String(secondsLeft%60).padStart(2,'0')}`}</div>
                {!started && <button className="px-3 py-1.5 rounded bg-indigo-600 text-white hover:bg-indigo-500" onClick={startRun}>Start</button>}
              </div>
            </div>

            <div className="border rounded-xl overflow-hidden bg-white">
              <div className="px-4 py-3 border-b text-sm text-slate-500">
                {started ? "Answer 5 questions before the timer runs out." : "Press Start to begin."}
              </div>
              <div className="bg-slate-50 p-3 h-[52vh] overflow-y-auto flex flex-col gap-4" ref={scrollRef}>
                {messages.map((m,i)=><Row key={i} from={m.from} text={m.text} time={m.time} />)}
                {typing && <div className="text-xs text-slate-500">Coach is typing…</div>}
              </div>
              <div className="px-4 py-3 border-t bg-white flex items-center justify-between">
                <div className="text-xs text-slate-500">
                  {started && !finished ? `${qCount}/${QUESTIONS_PER_RUN} answered` : ''}
                </div>
                <div className="flex gap-2 items-center w-2/3">
                  <input className="border rounded px-3 py-1.5 w-full"
                         placeholder={started && !finished ? "Type your reply…" : "Start the run to reply…"}
                         value={draft}
                         onChange={e=>setDraft(e.target.value)}
                         onKeyDown={e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); submit(); } }}
                         disabled={!started || finished}/>
                  <button className="px-3 py-1.5 rounded bg-emerald-600 text-white disabled:opacity-50"
                          disabled={!started || finished || !draft.trim()} onClick={submit}>Send</button>
                </div>
              </div>
            </div>
          </main>
        </div>
      );
    }

    function AccessGate({ onAccess }) {
      const [codeDraft, setCodeDraft] = useState('');
      const [checking, setChecking] = useState(false);
      const [accessErr, setAccessErr] = useState('');

      async function handleAccessSubmit(e) {
        e.preventDefault();
        if (!codeDraft.trim()) return;
        setChecking(true);
        setAccessErr('');
        try {
          const r = await fetch(CHECK_ACCESS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: codeDraft.trim() })
          });
          const data = await r.json().catch(() => ({}));
          if (!r.ok || !data?.ok) throw new Error(data?.error || 'Invalid code');
          onAccess();
          setCodeDraft('');
        } catch (err) {
          setAccessErr(err.message || 'Invalid code');
        } finally {
          setChecking(false);
        }
      }

      return (
        <div className="h-screen flex items-center justify-center bg-slate-900">
          <form onSubmit={handleAccessSubmit} className="bg-white rounded-lg p-6 shadow-lg flex flex-col gap-3 w-80">
            <h1 className="text-lg font-semibold text-slate-800">Enter Access Code</h1>
            <input className="border rounded px-3 py-2" placeholder="Access code" value={codeDraft} onChange={e => setCodeDraft(e.target.value)}/>
            {accessErr && <div className="text-rose-600 text-sm">{accessErr}</div>}
            <button type="submit" className="bg-indigo-600 text-white rounded px-3 py-2 hover:bg-indigo-500 disabled:opacity-50" disabled={checking}>
              {checking ? 'Checking…' : 'Enter'}
            </button>
          </form>
        </div>
      );
    }

    function Root() {
      const [accessOk, setAccessOk] = useState(false);
      if (!accessOk) {
        return <AccessGate onAccess={() => setAccessOk(true)} />;
      }
      return <App />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
  </script>
</body>
</html>
